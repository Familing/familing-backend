<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그 뷰어</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
<div class="w-full max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">로그 뷰어</h1>

    <!-- 필터 버튼 -->
    <div class="flex gap-2 items-center mb-4">
        <span class="text-sm font-medium w-20">필터:</span>
        <button id="allButton" class="flex items-center gap-2 px-4 py-2 rounded bg-blue-100 text-blue-700">
            전체 로그
        </button>
        <button id="errorButton" class="flex items-center gap-2 px-4 py-2 rounded bg-gray-100">
            <i class="fas fa-exclamation-circle mr-1"></i>
            에러만 보기
        </button>
        <button id="sqlButton" class="flex items-center gap-2 px-4 py-2 rounded bg-gray-100">
            <i class="fas fa-database mr-1"></i>
            SQL만 보기
        </button>
        <button id="infoButton" class="flex items-center gap-2 px-4 py-2 rounded bg-gray-100">
            <i class="fas fa-info-circle mr-1"></i>
            INFO만 보기
        </button>
    </div>

    <!-- 로그 표시 영역 -->
    <div id="logContainer" class="h-[calc(100vh-200px)] overflow-y-auto border rounded p-4 font-mono text-sm bg-white">
        <div id="logs"></div>
        <div id="loading" class="flex justify-center py-4 hidden">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
    </div>
</div>

<script>
    let page = 0;
    let hasMore = true;
    let loading = false;
    const filters = {
        showErrors: true,
        showSQL: true,
        showInfo: true
    };

    // 로그 색상 결정
    function getLogStyle(log) {
        if (log.includes('ERROR')) return 'text-red-600';
        if (log.includes('Hibernate:')) return 'text-green-600';
        if (log.includes('INFO')) return 'text-blue-600';
        return 'text-gray-800';
    }

    // 로그 렌더링
    function renderLog(log) {
        const div = document.createElement('div');
        div.className = `py-1 ${getLogStyle(log)} break-all`;
        div.textContent = log;
        return div;
    }

    // 로그 가져오기
    async function fetchLogs() {
        if (loading || !hasMore) return;

        loading = true;
        document.getElementById('loading').classList.remove('hidden');

        try {
            const response = await fetch(
                `/api/v1/log?page=${page}&size=100&includeErrors=${filters.showErrors}&includeSQL=${filters.showSQL}&includeInfo=${filters.showInfo}`
            );
            const data = await response.json();

            data.logs.forEach(log => {
                document.getElementById('logs').appendChild(renderLog(log));
            });

            hasMore = data.hasNextPage;
            page++;
        } catch (error) {
            console.error('Failed to fetch logs:', error);
        } finally {
            loading = false;
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // SSE 연결
    function connectSSE() {
        const eventSource = new EventSource(
            `/api/v1/log/stream?includeErrors=${filters.showErrors}&includeSQL=${filters.showSQL}&includeInfo=${filters.showInfo}`
        );

        eventSource.onmessage = (event) => {
            const newLogs = JSON.parse(event.data);
            const logsContainer = document.getElementById('logs');
            newLogs.forEach(log => {
                logsContainer.appendChild(renderLog(log));
            });
        };

        eventSource.onerror = () => {
            eventSource.close();
            setTimeout(connectSSE, 5000);
        };

        return eventSource;
    }

    // 스크롤 이벤트 처리
    document.getElementById('logContainer').addEventListener('scroll', (e) => {
        if (e.target.scrollTop === 0 && !loading && hasMore) {
            fetchLogs();
        }
    });

    // 필터 버튼 이벤트
    function setActiveButton(buttonId) {
        const buttons = ['allButton', 'errorButton', 'sqlButton', 'infoButton'];
        buttons.forEach(id => {
            const button = document.getElementById(id);
            if (id === buttonId) {
                button.classList.remove('bg-gray-100');
                button.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                button.classList.remove('bg-blue-100', 'text-blue-700');
                button.classList.add('bg-gray-100');
            }
        });
    }

    document.getElementById('allButton').addEventListener('click', () => {
        filters.showErrors = true;
        filters.showSQL = true;
        filters.showInfo = true;
        setActiveButton('allButton');
        resetAndRefetch();
    });

    document.getElementById('errorButton').addEventListener('click', () => {
        filters.showErrors = true;
        filters.showSQL = false;
        filters.showInfo = false;
        setActiveButton('errorButton');
        resetAndRefetch();
    });

    document.getElementById('sqlButton').addEventListener('click', () => {
        filters.showErrors = false;
        filters.showSQL = true;
        filters.showInfo = false;
        setActiveButton('sqlButton');
        resetAndRefetch();
    });

    document.getElementById('infoButton').addEventListener('click', () => {
        filters.showErrors = false;
        filters.showSQL = false;
        filters.showInfo = true;
        setActiveButton('infoButton');
        resetAndRefetch();
    });

    function resetAndRefetch() {
        document.getElementById('logs').innerHTML = '';
        page = 0;
        hasMore = true;
        fetchLogs();
        if (eventSource) {
            eventSource.close();
        }
        eventSource = connectSSE();
    }

    // 초기 로드
    let eventSource = connectSSE();
    fetchLogs();
</script>
</body>
</html>